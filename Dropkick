local Player = game.Players.LocalPlayer
local Character = Player.Character
local Root = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")

Player:SetAttribute("Run", false)

local function Cutscene()
	local Camera = workspace.CurrentCamera
	local Rig = game.ReplicatedStorage.Resources.CamLetterBox:Clone()
	Rig.Parent = workspace.Effects
	Rig.camerarootpart.CFrame = Root.CFrame
	Camera.CameraType = Enum.CameraType.Scriptable
	Camera.CFrame = Rig.camera.CFrame
	local Track = Rig.AnimationController:LoadAnimation(game.ReplicatedStorage.Resources.KJ.dropKickCam)
	Track:Play()
	local StartTime = tick()
	local Duration = 14
	
	repeat
		Camera.CFrame = Rig.camera.CFrame
		task.wait()
	until tick() - StartTime - Duration
	task.wait()
	Player.CameraMode = Enum.CameraMode.Classic
	Camera.CameraType = Enum.CameraType.Custom
	Camera.CameraSubject = Character:WaitForChild("Humanoid")
	Camera.FieldOfView = 75
	Camera.Focus = Character:WaitForChild("Head").CFrame
	Rig:Destroy()
end

Player:GetAttributeChangedSignal("Run"):Connect(function()
	if Player:GetAttribute("Run") then
		local Speed = 400 / 2.5
		local BodyVelocity = Instance.new("BodyVelocity", Root)
		BodyVelocity.MaxForce = Vector3.new(math.huge, 0, math.huge)
		BodyVelocity.Velocity = Root.CFrame.LookVector * Speed
		game.Debris:AddItem(BodyVelocity, 5)
		local IsDestroyed
		BodyVelocity.Destroying:Connect(function()
			IsDestroyed = true
		end)
		delay(4,function()
			Speed = 120 / 2.5
			repeat wait(0.1)
				if Speed >= 12 / 2.5 then
					Speed -= 12 / 2.5
				end
			until IsDestroyed
		end)
		local Attach
		Attach = game:GetService("RunService").RenderStepped:Connect(function()
			if not IsDestroyed then
				BodyVelocity.Velocity = Root.CFrame.LookVector * Speed
			elseif IsDestroyed then
				Attach:Disconnect()
				Attach = nil
			end
		end)
		repeat wait() until IsDestroyed
		task.wait(0.1)
		return IsDestroyed
	else
		for _,v in pairs(Root:GetChildren()) do
			if v and v:IsA("BodyVelocity") then
				v:Destroy()
			end
		end
	end
end)

local RunTrack = Humanoid:LoadAnimation(game.ReplicatedStorage.Resources.KJ.dropKick)
local HitTrack = Humanoid:LoadAnimation(game.ReplicatedStorage.Resources.KJ.dropKickHit)

local Step = "Startup"
spawn(function()
	if Humanoid.Health <= 0 then return end
	if not Character:FindFirstChild("movementFolder") then return end
	if not Character:FindFirstChild("movementFolder"):FindFirstChild("Value") then return end
	RunTrack:Play()
	local RunSound = game.ReplicatedStorage.Resources.KJ.dropkickWind:Clone()
	RunSound.Parent = game.SoundService
	RunSound:Play()
	Character:FindFirstChild("movementFolder").Value:SetAttribute("Speed", 0)
	task.delay(2.5, function()
		if RunTrack.IsPlaying then
			Player:SetAttribute("Run", true)
			local Hitbox = Instance.new("Part")
			Hitbox.Parent = workspace.Effects
			Hitbox.Size = Vector3.new(12, 5, 16)
			Hitbox.CFrame = Root.CFrame
			Hitbox.Transparency = 1
			Hitbox.CanCollide = false
			Hitbox.Massless = true
			Hitbox.Name = "Hitbox"
			local HitboxMotor6D = Instance.new("Motor6D")
			HitboxMotor6D.Parent = Hitbox
			HitboxMotor6D.Part0 = Hitbox
			HitboxMotor6D.Part1 = Root
			local Hit = false
			Hitbox.Touched:Connect(function(e)
				if e.Parent:FindFirstChild("Humanoid") and e.Parent ~= Character and not Hit then
					local Enemy = e.Parent
					local ERoot = Enemy:WaitForChild("HumanoidRootPart")
					local EHumanoid = Enemy:WaitForChild("Humanoid")
					
					Cutscene()
					HitTrack:Play()
					Humanoid.AutoRotate = false
					Root.Anchored = true
					Hitbox:Destroy()
					RunSound.Volume = 0
					local HitSound = game.ReplicatedStorage.Resources.KJ.dropkickS:Clone()
					HitSound.Parent = game.SoundService
					HitSound:Play()
					HitSound.Ended:Connect(function()
						HitSound:Destroy()
					end)
					HitTrack.Ended:Connect(function()
						Character:FindFirstChild("movementFolder"):FindFirstChild("Value"):SetAttribute("Speed", 30)
						Root.Anchored = false
						Humanoid.AutoRotate = false
					end)
				end
			end)
		end
	end)
	RunTrack.Ended:Connect(function()
		wait(0.2)
		if not HitTrack.IsPlaying then
			if Character:FindFirstChild("movementFolder") and Character:FindFirstChild("movementFolder"):FindFirstChild("Value") then
				Character:FindFirstChild("movementFolder"):FindFirstChild("Value"):SetAttribute("Speed", 30)
			end
		end
	end)
end)

Humanoid.HealthChanged:Connect(function()
	if Step ~= "Hit" then
		RunTrack:Stop()
	end
end)
